name: Documentation Sync

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**' # Prevent infinite loops if just docs changed

permissions:
  contents: write # Needed to commit changes back

jobs:
  sync-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Required to detect changed files in the latest commit

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Environment Variables
        run: |
          cd backend
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env
          echo "LINGO_API_KEY=${{ secrets.LINGO_API_KEY }}" >> .env

      - name: Start Backend Server
        run: npm run dev:backend &
        env:
          PORT: 3001
          # SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          # SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          # LINGO_API_KEY: ${{ secrets.LINGO_API_KEY }}

      - name: Wait for Backend to initialize
        run: |
          echo "Waiting for backend to start..."
          timeout 30 bash -c 'until curl -s http://localhost:3001/health; do sleep 2; done'
          echo "Backend is up!"

      - name: Trigger Documentation Compiler
        run: curl -X POST "http://localhost:3001/api/scan?compile=true"

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/
          # Only commit if there are changes
          git diff --staged --quiet || git commit -m "docs: auto-generate documentation for $(git rev-parse --short HEAD)"
          git push
